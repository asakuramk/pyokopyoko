<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„ÅäÂÆ∂„Å∏Â∏∞„Çç„ÅÜ v1.0</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            background: #87CEEB;
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
        }
        #root {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        .game-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        canvas {
            display: block;
            touch-action: none;
        }
        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .message-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 50px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            pointer-events: auto;
            border: 5px solid #FFD93D;
            max-width: 90%;
        }
        .message-box h1 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 32px;
        }
        .message-box p {
            margin: 0 0 20px 0;
            color: #555;
            font-size: 16px;
            line-height: 1.6;
        }
        .version {
            font-size: 14px !important;
            color: #FF6B6B !important;
            font-weight: bold;
            margin-bottom: 5px !important;
        }
        .btn {
            background: #FF6B6B;
            color: white;
            border: none;
            padding: 15px 45px;
            font-size: 22px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 0 #D64545;
            transition: all 0.1s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active {
            transform: translateY(5px);
            box-shadow: 0 0 0 #D64545;
        }
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .btn.secondary {
            background: #4FC3F7;
            box-shadow: 0 5px 0 #0288D1;
        }
        .score {
            position: absolute;
            top: 15px;
            left: 15px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.3);
            padding: 8px 20px;
            border-radius: 25px;
            pointer-events: none;
        }
        .high-score {
            position: absolute;
            top: 55px;
            left: 15px;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.25);
            padding: 6px 16px;
            border-radius: 20px;
            pointer-events: none;
        }
        .controls-hint {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        .update-time {
            position: absolute;
            top: 15px;
            right: 15px;
            color: white;
            font-size: 12px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.3);
            padding: 5px 15px;
            border-radius: 15px;
            pointer-events: none;
        }
        .name-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid #FFD93D;
            font-size: 16px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function Game() {
            const canvasRef = useRef(null);
            const [gameState, setGameState] = useState('name');
            const [gameMode, setGameMode] = useState('pyoko');
            const [playerName, setPlayerName] = useState('');
            const [nameInput, setNameInput] = useState('');
            const [players, setPlayers] = useState([]);
            const [highScores, setHighScores] = useState({
                pyoko: { name: '', score: 0 },
                crossy: { name: '', score: 0 }
            });
            const [crossyLevel, setCrossyLevel] = useState(1);
            const [score, setScore] = useState(0);
            const gameLoopRef = useRef(null);
            const gameDataRef = useRef({
                player: { x: 0, y: 0, vx: 0, vy: 0, width: 34, height: 34 },
                platforms: [],
                camera: { y: 0 },
                keys: { left: false, right: false },
                maxScore: 0,
                clouds: [],
                birds: [],
                poops: [],
                missiles: [],
                audioCtx: null,
                superJumpActive: false,
                crossy: {
                    player: { x: 0, y: 0, size: 24 },
                    cars: [],
                    laneHeight: 50,
                    laneCount: 8,
                    score: 0,
                    level: 1,
                    speedMultiplier: 1
                }
            });

            const GRAVITY = 0.4;
            const JUMP_FORCE = -11.5;
            const MOVE_SPEED = 5.5;
            const GOAL_HEIGHT = 6000;

            const computeHighScores = (list) => {
                const bestPyoko = list.reduce((acc, p) => {
                    return p.pyokoHigh > acc.score ? { name: p.name, score: p.pyokoHigh } : acc;
                }, { name: '', score: 0 });
                const bestCrossy = list.reduce((acc, p) => {
                    return p.crossyHigh > acc.score ? { name: p.name, score: p.crossyHigh } : acc;
                }, { name: '', score: 0 });
                return { pyoko: bestPyoko, crossy: bestCrossy };
            };

            const updatePlayerScore = (mode, newScore) => {
                if (!playerName) return;
                setPlayers(prev => {
                    const updated = [...prev];
                    const index = updated.findIndex(p => p.name === playerName);
                    if (index === -1) {
                        updated.push({
                            name: playerName,
                            pyokoHigh: mode === 'pyoko' ? newScore : 0,
                            crossyHigh: mode === 'crossy' ? newScore : 0
                        });
                    } else {
                        if (mode === 'pyoko' && newScore > updated[index].pyokoHigh) {
                            updated[index].pyokoHigh = newScore;
                        }
                        if (mode === 'crossy' && newScore > updated[index].crossyHigh) {
                            updated[index].crossyHigh = newScore;
                        }
                    }
                    setHighScores(computeHighScores(updated));
                    return updated;
                });
            };

            // Èü≥„ÅÆÊ∫ñÂÇôÔºà„É¶„Éº„Ç∂„ÉºÊìç‰Ωú„ÅßÂÜçÈñãÔºâ
            const ensureAudio = () => {
                const data = gameDataRef.current;
                if (!data.audioCtx) {
                    data.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (data.audioCtx.state === 'suspended') {
                    data.audioCtx.resume();
                }
                return data.audioCtx;
            };

            useEffect(() => {
                const savedPlayers = JSON.parse(localStorage.getItem('players') || '[]');
                const lastName = localStorage.getItem('lastPlayerName') || '';
                setPlayers(savedPlayers);
                setHighScores(computeHighScores(savedPlayers));
                setNameInput(lastName);
                setGameState('name');
            }, []);

            useEffect(() => {
                localStorage.setItem('players', JSON.stringify(players));
                if (playerName) {
                    localStorage.setItem('lastPlayerName', playerName);
                }
            }, [players, playerName]);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                const resizeCanvas = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                };
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);

                return () => window.removeEventListener('resize', resizeCanvas);
            }, []);

            useEffect(() => {
                if (gameState !== 'playing') return;

                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');

                // „Å¥„Çá„Åì„Å¥„Çá„ÅìÂàùÊúüÂåñ
                const initGame = () => {
                    const data = gameDataRef.current;
                    data.player.x = canvas.width / 2 - 17;
                    data.player.y = canvas.height - 150;
                    data.player.vx = 0;
                    data.player.vy = 0;
                    data.camera.y = 0;
                    data.maxScore = 0;

                    // Èü≥„ÅÆÊ∫ñÂÇôÔºàÂÆüÈöõ„ÅÆÂÜçÈñã„ÅØ„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÊôÇ„Å´Ë°å„ÅÜÔºâ
                    if (!data.audioCtx) {
                        data.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    }

                    // Èõ≤„ÅÆÂàùÊúüÂåñ
                    data.clouds = [];
                    for (let i = 0; i < 15; i++) {
                        data.clouds.push({
                            x: Math.random() * canvas.width,
                            y: Math.random() * canvas.height - Math.random() * GOAL_HEIGHT,
                            speed: 0.2 + Math.random() * 0.3,
                            size: 30 + Math.random() * 40
                        });
                    }

                    // È≥•„ÅÆÂàùÊúüÂåñÔºàÁîªÈù¢‰ªòËøë„Å´Âá∫ÁèæÔºâ
                    data.birds = [];
                    for (let i = 0; i < 5; i++) {
                        data.birds.push({
                            x: Math.random() * canvas.width,
                            y: data.camera.y - 200 - Math.random() * 600,
                            vx: (Math.random() < 0.5 ? -1 : 1) * (1.5 + Math.random()),
                            size: 20,
                            poopTimer: 30 + Math.random() * 120
                        });
                    }

                    // „ÅÜ„Çì„Å°ÈÖçÂàó
                    data.poops = [];

                    // Ë∂≥Â†¥ÁîüÊàê
                    data.platforms = [];
                    let prevX = canvas.width / 2 - 100;
                    data.platforms.push({
                        x: prevX, y: canvas.height - 50, w: 200, h: 20, type: 'normal'
                    });

                    let currentY = canvas.height - 50;
                    while (currentY > -GOAL_HEIGHT) {
                        const gap = 70 + Math.random() * 60;
                        currentY -= gap;

                        let w = 90 + Math.random() * 20;
                        let minX = Math.max(0, prevX - 280);
                        let maxX = Math.min(canvas.width - w, prevX + 280);
                        let x = minX + Math.random() * (maxX - minX);

                        data.platforms.push({
                            x: x, y: currentY, w: w, h: 20, type: 'normal'
                        });
                        prevX = x;
                    }

                    // „Ç¥„Éº„É´
                    data.platforms.push({
                        x: canvas.width / 2 - 150, y: -GOAL_HEIGHT,
                        w: 300, h: 20, type: 'goal'
                    });
                };

                // „ÇØ„É≠„ÉÉ„Ç∑„Éº„É≠„Éº„ÉâÂàùÊúüÂåñ
                const initCrossy = () => {
                    const data = gameDataRef.current;
                    const crossy = data.crossy;
                    crossy.player.x = canvas.width / 2 - crossy.player.size / 2;
                    crossy.player.y = canvas.height - 60;
                    crossy.cars = [];
                    crossy.score = 0;
                    const laneHeight = crossy.laneHeight;
                    for (let i = 0; i < crossy.laneCount; i++) {
                        const y = canvas.height - (i + 2) * laneHeight;
                        const dir = i % 2 === 0 ? 1 : -1;
                        const speed = (2 + i * 0.2 + Math.random()) * crossy.speedMultiplier;
                        const carCount = 2 + (i % 2);
                        for (let c = 0; c < carCount; c++) {
                            crossy.cars.push({
                                x: Math.random() * canvas.width,
                                y,
                                w: 40,
                                h: 20,
                                vx: dir * speed
                            });
                        }
                    }
                };

                if (gameMode === 'pyoko') {
                    initGame();
                } else {
                    initCrossy();
                }

                // Èü≥„ÇíÈ≥¥„Çâ„ÅôÈñ¢Êï∞
                const playSound = (type) => {
                    const audioCtx = ensureAudio();
                    if (!audioCtx) return;

                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();

                    if (type === 'jump') {
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.15);
                    } else if (type === 'gameover') {
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                        osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.5);
                        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.5);
                    } else if (type === 'hit') {
                        osc.type = 'square';
                        osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.2);
                        gain.gain.setValueAtTime(0.4, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.start();
                        osc.stop(audioCtx.currentTime + 0.2);
                    }
                };

                // „Ç≤„Éº„É†„É´„Éº„Éó
                const gameLoop = () => {
                    const data = gameDataRef.current;

                    if (gameMode === 'crossy') {
                        const crossy = data.crossy;

                        // Ëªä„ÅÆÊõ¥Êñ∞
                        crossy.cars.forEach(car => {
                            car.x += car.vx;
                            if (car.vx > 0 && car.x > canvas.width + 60) car.x = -60;
                            if (car.vx < 0 && car.x < -60) car.x = canvas.width + 60;
                        });

                        // Ë°ùÁ™ÅÂà§ÂÆö
                        crossy.cars.forEach(car => {
                            if (
                                crossy.player.x + crossy.player.size > car.x &&
                                crossy.player.x < car.x + car.w &&
                                crossy.player.y + crossy.player.size > car.y &&
                                crossy.player.y < car.y + car.h
                            ) {
                                playSound('hit');
                                setGameState('gameover');
                            }
                        });

                        // „Çπ„Ç≥„Ç¢
                        const currentCrossyScore = Math.max(0, Math.floor((canvas.height - crossy.player.y) / 10));
                        if (currentCrossyScore > crossy.score) {
                            crossy.score = currentCrossyScore;
                            setScore(currentCrossyScore);
                            updatePlayerScore('crossy', currentCrossyScore);
                        }

                        // „Ç¥„Éº„É´
                        if (crossy.player.y < 20) {
                            setGameState('win');
                        }

                        // ÊèèÁîª
                        ctx.fillStyle = '#87CEEB';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // ÈÅì„Å®Ëçâ
                        const laneHeight = crossy.laneHeight;
                        for (let i = 0; i < crossy.laneCount + 2; i++) {
                            const y = canvas.height - (i + 1) * laneHeight;
                            ctx.fillStyle = i % 2 === 0 ? '#9CCC65' : '#616161';
                            ctx.fillRect(0, y, canvas.width, laneHeight);
                        }

                        // ËªäÊèèÁîª
                        crossy.cars.forEach(car => {
                            ctx.fillStyle = '#FF7043';
                            ctx.fillRect(car.x, car.y, car.w, car.h);
                            ctx.fillStyle = '#212121';
                            ctx.fillRect(car.x + 5, car.y + 4, 8, 6);
                            ctx.fillRect(car.x + car.w - 13, car.y + 4, 8, 6);
                        });

                        // „Éó„É¨„Ç§„É§„ÉºÊèèÁîª
                        ctx.fillStyle = '#FFD93D';
                        ctx.fillRect(crossy.player.x, crossy.player.y, crossy.player.size, crossy.player.size);
                        ctx.fillStyle = '#333';
                        ctx.fillRect(crossy.player.x + 6, crossy.player.y + 6, 4, 4);
                        ctx.fillRect(crossy.player.x + crossy.player.size - 10, crossy.player.y + 6, 4, 4);

                        gameLoopRef.current = requestAnimationFrame(gameLoop);
                        return;
                    }

                    // Êõ¥Êñ∞
                    if (data.keys.left) data.player.vx = -MOVE_SPEED;
                    else if (data.keys.right) data.player.vx = MOVE_SPEED;
                    else data.player.vx *= 0.8;

                    data.player.x += data.player.vx;
                    if (data.player.x + data.player.width < 0) data.player.x = canvas.width;
                    if (data.player.x > canvas.width) data.player.x = -data.player.width;

                    data.player.vy += GRAVITY;
                    data.player.y += data.player.vy;

                    // Èõ≤„ÅÆÊõ¥Êñ∞
                    data.clouds.forEach(c => {
                        c.x += c.speed;
                        if (c.x > canvas.width + 100) {
                            c.x = -100;
                            c.y = data.camera.y - 200 - Math.random() * 400;
                        }
                    });

                    // È≥•„ÅÆÊõ¥Êñ∞
                    data.birds.forEach(bird => {
                        bird.x += bird.vx;
                        if (bird.x < -50 || bird.x > canvas.width + 50) {
                            bird.vx *= -1;
                        }

                        // ÁîªÈù¢Â§ñ„Å´ËêΩ„Å°„ÅüÈ≥•„ÅØ‰∏ä„Å´ÂÜçÈÖçÁΩÆ
                        if (bird.y - data.camera.y > canvas.height + 200) {
                            bird.y = data.camera.y - 200 - Math.random() * 600;
                            bird.poopTimer = 30 + Math.random() * 120;
                        }

                        // „ÅÜ„Çì„Å°„ÇíËêΩ„Å®„Åô
                        bird.poopTimer--;
                        if (bird.poopTimer <= 0) {
                            data.poops.push({
                                x: bird.x + 10,
                                y: bird.y + 10,
                                vy: 0.8  // ÈÄüÂ∫¶„ÇíÈÅÖ„Åè„Åó„ÅüÔºà2.0 ‚Üí 0.8Ôºâ
                            });
                            bird.poopTimer = 150 + Math.random() * 100;
                        }
                    });

                    // „ÅÜ„Çì„Å°„ÅÆÊõ¥Êñ∞
                    data.poops.forEach(poop => {
                        poop.y += poop.vy;
                        poop.vy += 0.2; // ÈáçÂäõ
                    });
                    data.poops = data.poops.filter(poop => poop.y < data.camera.y + canvas.height + 100);

                    // „Éü„Çµ„Ç§„É´„ÅÆÊõ¥Êñ∞
                    data.missiles.forEach(missile => {
                        missile.y -= 8;
                    });
                    data.missiles = data.missiles.filter(missile => missile.y > -50);

                    // „Éü„Çµ„Ç§„É´„Å®„ÅÜ„Çì„Å°„ÅÆË°ùÁ™ÅÂà§ÂÆö
                    data.missiles.forEach((missile, mIndex) => {
                        data.poops.forEach((poop, pIndex) => {
                            if (
                                missile.x > poop.x - 15 &&
                                missile.x < poop.x + 15 &&
                                missile.y > poop.y - 15 &&
                                missile.y < poop.y + 15
                            ) {
                                playSound('hit');
                                data.missiles.splice(mIndex, 1);
                                data.poops.splice(pIndex, 1);
                            }
                        });
                    });

                    // È≥•„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
                    data.birds.forEach(bird => {
                        const birdScreenY = bird.y - data.camera.y;
                        if (
                            Math.abs(birdScreenY - (data.player.y - data.camera.y)) < canvas.height &&
                            data.player.x + data.player.width > bird.x &&
                            data.player.x < bird.x + bird.size &&
                            data.player.y + data.player.height > bird.y &&
                            data.player.y < bird.y + bird.size
                        ) {
                            playSound('hit');
                            setGameState('gameover');
                        }
                    });

                    // „ÅÜ„Çì„Å°„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
                    data.poops.forEach(poop => {
                        if (
                            data.player.x + data.player.width > poop.x &&
                            data.player.x < poop.x + 8 &&
                            data.player.y + data.player.height > poop.y &&
                            data.player.y < poop.y + 8
                        ) {
                            playSound('hit');
                            setGameState('gameover');
                        }
                    });

                    // Ë°ùÁ™ÅÂà§ÂÆö
                    if (data.player.vy > 0) {
                        data.platforms.forEach(p => {
                            if (
                                data.player.x + data.player.width > p.x &&
                                data.player.x < p.x + p.w &&
                                data.player.y + data.player.height > p.y &&
                                data.player.y + data.player.height < p.y + p.h + 10
                            ) {
                                data.player.y = p.y - data.player.height;
                                // „Çπ„Éº„Éë„Éº„Ç∏„É£„É≥„Éó„ÅÆÂà§ÂÆöÔºà2/3„ÇíË∂Ö„Åà„Åü„ÇâÔºâ
                                const jumpForce = data.superJumpActive ? JUMP_FORCE * 1.8 : JUMP_FORCE;
                                data.player.vy = jumpForce;
                                data.superJumpActive = false; // 1ÂõûÈôê„Çä„Å™„ÅÆ„ÅßËß£Èô§
                                playSound('jump');

                                if (p.type === 'goal') {
                                    setGameState('win');
                                }
                            }
                        });
                    }

                    // „Ç´„É°„É©
                    const targetCamY = data.player.y - canvas.height / 2;
                    if (targetCamY < data.camera.y) {
                        data.camera.y = targetCamY;
                    }

                    // „Çπ„Ç≥„Ç¢
                    const currentHeight = Math.floor((canvas.height - data.player.y) / 10);
                    if (currentHeight > data.maxScore) {
                        data.maxScore = currentHeight;
                        setScore(currentHeight);
                        updatePlayerScore('pyoko', currentHeight);
                    }

                    // 1/3„ÇíË∂Ö„Åà„Åü„Çâ„Éü„Çµ„Ç§„É´Ê©üËÉΩÊúâÂäπ
                    const enableMissile = currentHeight > GOAL_HEIGHT / 3;
                    // 2/3„ÇíË∂Ö„Åà„Åü„Çâ„Çπ„Éº„Éë„Éº„Ç∏„É£„É≥„Éó„É¢„Éº„ÉâÊúâÂäπ
                    const enableSuperJump = currentHeight > GOAL_HEIGHT * 2 / 3;

                    // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
                    if (data.player.y > data.camera.y + canvas.height + 100) {
                        playSound('gameover');
                        setGameState('gameover');
                    }

                    // ÊèèÁîªÔºàÊ∞¥Ëâ≤ËÉåÊôØÔºâ
                    const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                    grad.addColorStop(0, '#87CEEB');
                    grad.addColorStop(1, '#B0E0E6');
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Èõ≤ÊèèÁîª
                    data.clouds.forEach(c => {
                        const cloudY = c.y - data.camera.y;
                        if (cloudY > -100 && cloudY < canvas.height + 100) {
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                            ctx.beginPath();
                            ctx.arc(c.x, cloudY, c.size, 0, Math.PI * 2);
                            ctx.arc(c.x + c.size * 0.6, cloudY - c.size * 0.3, c.size * 0.8, 0, Math.PI * 2);
                            ctx.arc(c.x + c.size * 1.1, cloudY + c.size * 0.1, c.size * 0.7, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    });

                    // È≥•ÊèèÁîª
                    data.birds.forEach(bird => {
                        const birdY = bird.y - data.camera.y;
                        if (birdY > -100 && birdY < canvas.height + 100) {
                            ctx.fillStyle = '#8B4513';
                            ctx.beginPath();
                            ctx.arc(bird.x + 10, birdY + 10, 8, 0, Math.PI * 2);
                            ctx.fill();

                            // Áøº
                            ctx.strokeStyle = '#8B4513';
                            ctx.lineWidth = 3;
                            ctx.beginPath();
                            const wingOffset = Math.sin(Date.now() / 100) * 5;
                            ctx.moveTo(bird.x, birdY + 10);
                            ctx.lineTo(bird.x - 8, birdY + wingOffset);
                            ctx.moveTo(bird.x + 20, birdY + 10);
                            ctx.lineTo(bird.x + 28, birdY + wingOffset);
                            ctx.stroke();
                        }
                    });

                    // „ÅÜ„Çì„Å°ÊèèÁîª
                    data.poops.forEach(poop => {
                        const poopY = poop.y - data.camera.y;
                        if (poopY > -20 && poopY < canvas.height + 20) {
                            ctx.fillStyle = '#8B4513';
                            ctx.beginPath();
                            ctx.arc(poop.x, poopY, 4, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    });

                    // „Éü„Çµ„Ç§„É´ÊèèÁîª
                    if (enableMissile) {
                        data.missiles.forEach(missile => {
                            const missileScreenY = missile.y - data.camera.y;
                            if (missileScreenY > -20 && missileScreenY < canvas.height + 20) {
                                ctx.fillStyle = '#FF4444';
                                ctx.fillRect(missile.x - 2, missileScreenY - 8, 4, 16);
                                // ÁÇé
                                ctx.fillStyle = '#FFA500';
                                ctx.beginPath();
                                ctx.moveTo(missile.x - 3, missileScreenY + 10);
                                ctx.lineTo(missile.x + 3, missileScreenY + 10);
                                ctx.lineTo(missile.x, missileScreenY + 15);
                                ctx.closePath();
                                ctx.fill();
                            }
                        });
                    }

                    // Ë∂≥Â†¥ÊèèÁîª
                    data.platforms.forEach(p => {
                        const screenY = p.y - data.camera.y;
                        if (screenY > -50 && screenY < canvas.height + 50) {
                            ctx.fillStyle = p.type === 'goal' ? '#FFD93D' : '#65B741';
                            ctx.fillRect(p.x, screenY, p.w, p.h);
                        }
                    });

                    // „Éó„É¨„Ç§„É§„ÉºÊèèÁîª
                    const playerScreenY = data.player.y - data.camera.y;
                    ctx.fillStyle = '#FFD93D';
                    ctx.fillRect(data.player.x, playerScreenY, data.player.width, data.player.height);

                    // È°î
                    ctx.fillStyle = '#333';
                    const centerX = data.player.x + data.player.width / 2;
                    ctx.beginPath();
                    ctx.arc(centerX - 7, playerScreenY + 12, 3, 0, Math.PI * 2);
                    ctx.arc(centerX + 7, playerScreenY + 12, 3, 0, Math.PI * 2);
                    ctx.fill();

                    gameLoopRef.current = requestAnimationFrame(gameLoop);
                };

                gameLoop();

                return () => {
                    if (gameLoopRef.current) {
                        cancelAnimationFrame(gameLoopRef.current);
                    }
                };
            }, [gameState]);

            // „Çø„ÉÉ„ÉÅÊìç‰Ωú
            useEffect(() => {
                const moveCrossy = (dx, dy) => {
                    const data = gameDataRef.current;
                    const crossy = data.crossy;
                    const step = crossy.laneHeight / 1.5;
                    crossy.player.x = Math.max(0, Math.min(window.innerWidth - crossy.player.size, crossy.player.x + dx * step));
                    crossy.player.y = Math.max(0, Math.min(window.innerHeight - crossy.player.size, crossy.player.y + dy * step));
                };

                const handleTouchStart = (e) => {
                    if (gameState !== 'playing') return;
                    e.preventDefault();
                    const touchX = e.touches[0].clientX;
                    const touchY = e.touches[0].clientY;
                    const data = gameDataRef.current;
                    if (gameMode === 'crossy') {
                        const centerX = window.innerWidth / 2;
                        const centerY = window.innerHeight / 2;
                        const dx = touchX < centerX ? -1 : 1;
                        const dy = touchY < centerY ? -1 : 1;
                        // Êñú„ÇÅ„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÄÅÂÑ™ÂÖàÊñπÂêë„ÇíÊ±∫ÂÆö
                        if (Math.abs(touchX - centerX) > Math.abs(touchY - centerY)) {
                            moveCrossy(dx, 0);
                        } else {
                            moveCrossy(0, dy);
                        }
                        return;
                    }
                    if (touchX < window.innerWidth / 2) {
                        data.keys.left = true;
                        data.keys.right = false;
                    } else {
                        data.keys.right = true;
                        data.keys.left = false;
                    }
                };

                const handleTouchEnd = (e) => {
                    e.preventDefault();
                    const data = gameDataRef.current;
                    data.keys.left = false;
                    data.keys.right = false;
                };

                const handleKeyDown = (e) => {
                    const data = gameDataRef.current;
                    if (gameState !== 'playing') return;

                    if (gameMode === 'crossy') {
                        if (e.code === 'ArrowUp') moveCrossy(0, -1);
                        if (e.code === 'ArrowDown') moveCrossy(0, 1);
                        if (e.code === 'ArrowLeft') moveCrossy(-1, 0);
                        if (e.code === 'ArrowRight') moveCrossy(1, 0);
                        return;
                    }

                    if (e.code === 'ArrowLeft') data.keys.left = true;
                    if (e.code === 'ArrowRight') data.keys.right = true;

                    // „Çπ„Éö„Éº„Çπ„Ç≠„Éº„Åß„Éü„Çµ„Ç§„É´Áô∫Â∞Ñ
                    if (e.code === 'Space' && data.maxScore > GOAL_HEIGHT / 3) {
                        e.preventDefault();
                        data.missiles.push({
                            x: data.player.x + data.player.width / 2,
                            y: data.player.y
                        });
                    }

                    // S„Ç≠„Éº„Åß„Çπ„Éº„Éë„Éº„Ç∏„É£„É≥„ÉóÊúâÂäπÂåñ
                    if (e.code === 'KeyS' && data.maxScore > GOAL_HEIGHT * 2 / 3) {
                        e.preventDefault();
                        data.superJumpActive = true;
                    }
                };

                const handleKeyUp = (e) => {
                    const data = gameDataRef.current;
                    if (e.code === 'ArrowLeft') data.keys.left = false;
                    if (e.code === 'ArrowRight') data.keys.right = false;
                };

                window.addEventListener('touchstart', handleTouchStart, { passive: false });
                window.addEventListener('touchend', handleTouchEnd, { passive: false });
                window.addEventListener('keydown', handleKeyDown);
                window.addEventListener('keyup', handleKeyUp);

                return () => {
                    window.removeEventListener('touchstart', handleTouchStart);
                    window.removeEventListener('touchend', handleTouchEnd);
                    window.removeEventListener('keydown', handleKeyDown);
                    window.removeEventListener('keyup', handleKeyUp);
                };
            }, [gameState]);

            const handleNameSubmit = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                const trimmed = nameInput.trim();
                if (!trimmed) return;
                setPlayers(prev => {
                    const exists = prev.some(p => p.name === trimmed);
                    if (exists) return prev;
                    return [...prev, { name: trimmed, pyokoHigh: 0, crossyHigh: 0 }];
                });
                setPlayerName(trimmed);
                setGameState('menu');
            };

            const handleStart = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                if (!playerName) {
                    setGameState('name');
                    return;
                }
                // iPhone„Åß„ÅÆÈü≥ÂÜçÁîü„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã
                if (typeof ensureAudio === 'function') {
                    ensureAudio();
                } else if (gameDataRef.current?.audioCtx?.state === 'suspended') {
                    gameDataRef.current.audioCtx.resume();
                }
                setScore(0);
                setGameState('playing');
            };

            const handleRetry = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                // iPhone„Åß„ÅÆÈü≥ÂÜçÁîü„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã
                if (typeof ensureAudio === 'function') {
                    ensureAudio();
                } else if (gameDataRef.current?.audioCtx?.state === 'suspended') {
                    gameDataRef.current.audioCtx.resume();
                }
                if (gameMode === 'crossy') {
                    const data = gameDataRef.current;
                    data.crossy.level = 1;
                    data.crossy.speedMultiplier = 1;
                    setCrossyLevel(1);
                }
                setScore(0);
                setGameState('playing');
            };

            const handleNextLevel = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                if (typeof ensureAudio === 'function') {
                    ensureAudio();
                }
                const data = gameDataRef.current;
                data.crossy.level += 1;
                data.crossy.speedMultiplier *= 1.2;
                setCrossyLevel(data.crossy.level);
                setScore(0);
                setGameState('playing');
            };

            // Êõ¥Êñ∞ÊôÇÂàª„ÇíÂèñÂæó
            const updateTime = new Date().toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            const getRanking = (mode) => {
                return players
                    .map(p => ({
                        name: p.name,
                        score: mode === 'pyoko' ? p.pyokoHigh : p.crossyHigh
                    }))
                    .filter(p => p.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 5);
            };

            const ranking = getRanking(gameMode);
            const topPlayer = ranking[0];

            return (
                <div className="game-container">
                    <canvas ref={canvasRef} />

                    <div className="update-time">Êõ¥Êñ∞: {updateTime} / ÂêçÂâç: {playerName || 'Êú™ÁôªÈå≤'}</div>

                    {gameState === 'playing' && (
                        <>
                            <div className="score">
                                {gameMode === 'pyoko' ? `È´ò„Åï: ${score}m` : `„Çπ„Ç≥„Ç¢: ${score} / Èù¢: ${crossyLevel}`}
                            </div>
                            <div className="high-score">
                                {gameMode === 'pyoko'
                                    ? `„Éè„Ç§„Çπ„Ç≥„Ç¢: ${highScores.pyoko.name || '---'} ${highScores.pyoko.score}m`
                                    : `„Éè„Ç§„Çπ„Ç≥„Ç¢: ${highScores.crossy.name || '---'} ${highScores.crossy.score}`}
                            </div>
                            <div className="controls-hint">
                                {gameMode === 'pyoko' && (
                                    <>
                                        PC: Áü¢Âç∞„Ç≠„Éº / „Çπ„Éû„Éõ: ÁîªÈù¢Â∑¶Âè≥„Çø„ÉÉ„Éó<br/>
                                        {score > GOAL_HEIGHT / 3 && <span>Space: „Éü„Çµ„Ç§„É´Áô∫Â∞Ñ | </span>}
                                        {score > GOAL_HEIGHT * 2 / 3 && <span>S: „Çπ„Éº„Éë„Éº„Ç∏„É£„É≥„Éó</span>}
                                    </>
                                )}
                                {gameMode === 'crossy' && (
                                    <>
                                        PC: Áü¢Âç∞„Ç≠„Éº / „Çπ„Éû„Éõ: ÁîªÈù¢„Çø„ÉÉ„Éó„ÅßÊñπÂêëÁßªÂãï
                                    </>
                                )}
                            </div>
                        </>
                    )}

                    <div className="ui-overlay">
                        {gameState === 'name' && (
                            <div className="message-box">
                                <h1>üìù ÂêçÂâçÁôªÈå≤</h1>
                                <p>„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„ÇãÂâç„Å´ÂêçÂâç„ÇíÈÅ∏Êäû„Åæ„Åü„ÅØÊñ∞Ë¶èÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                                {players.length > 0 && (
                                    <div className="menu-buttons" style={{ marginBottom: '12px' }}>
                                        {players.map((p) => (
                                            <button
                                                key={p.name}
                                                className="btn secondary"
                                                onTouchEnd={(e) => {
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    setPlayerName(p.name);
                                                    setNameInput(p.name);
                                                    setGameState('menu');
                                                }}
                                                onClick={() => {
                                                    setPlayerName(p.name);
                                                    setNameInput(p.name);
                                                    setGameState('menu');
                                                }}
                                            >
                                                {p.name} „ÇíÈÅ∏Êäû
                                            </button>
                                        ))}
                                    </div>
                                )}
                                <input
                                    className="name-input"
                                    type="text"
                                    placeholder="ÂêçÂâç"
                                    value={nameInput}
                                    onChange={(e) => setNameInput(e.target.value)}
                                />
                                <button
                                    className="btn"
                                    onTouchEnd={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        handleNameSubmit(e);
                                    }}
                                    onClick={handleNameSubmit}
                                >
                                    Êñ∞Ë¶èÁôªÈå≤„Åó„Å¶ÈÄ≤„ÇÄ
                                </button>
                            </div>
                        )}

                        {gameState === 'menu' && (
                            <div className="message-box">
                                <h1>üéÆ „Ç≤„Éº„É†„ÇíÈÅ∏„Çì„Åß„Å≠</h1>
                                <p>{playerName ? `„Çà„ÅÜ„Åì„Åù„ÄÅ${playerName}„Åï„ÇìÔºÅ` : 'ÈÅä„Å≥„Åü„ÅÑ„Ç≤„Éº„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'}</p>
                                <div className="menu-buttons">
                                    <button
                                        className="btn"
                                        onTouchEnd={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setGameMode('pyoko');
                                            setScore(0);
                                            setGameState('start');
                                        }}
                                        onClick={() => {
                                            setGameMode('pyoko');
                                            setScore(0);
                                            setGameState('start');
                                        }}
                                    >
                                        üè† „ÅäÂÆ∂„Å∏Â∏∞„Çç„ÅÜ
                                    </button>
                                    <button
                                        className="btn secondary"
                                        onTouchEnd={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setGameMode('crossy');
                                            const data = gameDataRef.current;
                                            data.crossy.level = 1;
                                            data.crossy.speedMultiplier = 1;
                                            setCrossyLevel(1);
                                            setScore(0);
                                            setGameState('start');
                                        }}
                                        onClick={() => {
                                            setGameMode('crossy');
                                            const data = gameDataRef.current;
                                            data.crossy.level = 1;
                                            data.crossy.speedMultiplier = 1;
                                            setCrossyLevel(1);
                                            setScore(0);
                                            setGameState('start');
                                        }}
                                    >
                                        üê• „ÇØ„É≠„ÉÉ„Ç∑„Éº„É≠„Éº„Éâ
                                    </button>
                                </div>
                            </div>
                        )}

                        {gameState === 'start' && (
                            <div className="message-box">
                                <h1>{gameMode === 'pyoko' ? 'üè† „ÅäÂÆ∂„Å∏Â∏∞„Çç„ÅÜ' : 'üê• „ÇØ„É≠„ÉÉ„Ç∑„Éº„É≠„Éº„Éâ'}</h1>
                                <p className="version">v1.0 ReactÁâà</p>
                                {gameMode === 'pyoko' && <p>„Ç∏„É£„É≥„Éó„Åó„Å¶6000m‰∏ä„ÅÆ„ÅäÂÆ∂„ÇíÁõÆÊåá„Åù„ÅÜÔºÅ</p>}
                                {gameMode === 'crossy' && (
                                    <p>
                                        Ëªä„ÇíÈÅø„Åë„Å¶‰∏ä„Å∏ÈÄ≤„ÇÇ„ÅÜÔºÅ<br/>
                                        ÁèæÂú®„ÅÆÈù¢: {crossyLevel} / ËªäÈÄüÂ∫¶ x{gameDataRef.current.crossy.speedMultiplier.toFixed(2)}
                                    </p>
                                )}
                                <button
                                    className="btn"
                                    onTouchEnd={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        handleStart(e);
                                    }}
                                    onClick={handleStart}
                                >
                                    „Çπ„Çø„Éº„ÉàÔºÅ
                                </button>
                            </div>
                        )}

                        {gameState === 'gameover' && (
                            <div className="message-box">
                                <h1 style={{color: '#FF6B6B'}}>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</h1>
                                {gameMode === 'pyoko' && <p>Âà∞ÈÅîÈ´ò„Åï: {score}m</p>}
                                {gameMode === 'crossy' && <p>„Çπ„Ç≥„Ç¢: {score} / Èù¢: {crossyLevel}</p>}
                                {ranking.length > 0 ? (
                                    <div>
                                        <p>üèÜ „Éè„Ç§„Çπ„Ç≥„Ç¢„É©„É≥„Ç≠„É≥„Ç∞</p>
                                        {ranking.map((r, i) => (
                                            <p key={`${r.name}-${i}`}>{i + 1}. {r.name} - {r.score}{gameMode === 'pyoko' ? 'm' : ''}</p>
                                        ))}
                                        {topPlayer && <p>„Éà„ÉÉ„Éó„ÅÆ{topPlayer.name}„Åï„Çì„ÄÅÁ•û„É¨„Éô„É´„Åß„ÅôÔºÅ</p>}
                                    </div>
                                ) : (
                                    <p>„Åæ„Å†„É©„É≥„Ç≠„É≥„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                                )}
                                <button
                                    className="btn"
                                    onTouchEnd={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        handleRetry(e);
                                    }}
                                    onClick={handleRetry}
                                >
                                    „ÇÇ„ÅÜ‰∏ÄÂõûÔºÅ
                                </button>
                                <button
                                    className="btn secondary"
                                    onTouchEnd={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        setGameState('menu');
                                    }}
                                    onClick={() => setGameState('menu')}
                                >
                                    „Ç≤„Éº„É†ÈÅ∏Êäû„Å∏
                                </button>
                            </div>
                        )}

                        {gameState === 'win' && (
                            <div className="message-box">
                                <h1 style={{color: '#4ECDC4'}}>
                                    {gameMode === 'pyoko' ? 'üéâ „Åü„Å†„ÅÑ„Åæ„Å£ÔºÅ' : 'üéâ Èù¢„ÇØ„É™„Ç¢ÔºÅ'}
                                </h1>
                                {gameMode === 'pyoko' && (
                                    <>
                                        <p>ÁÑ°‰∫ã„Å´„ÅäÂÆ∂„Å´Â∏∞„Çå„Åæ„Åó„ÅüÔºÅ</p>
                                        <p>Âà∞ÈÅîÈ´ò„Åï: {score}m</p>
                                    </>
                                )}
                                {gameMode === 'crossy' && (
                                    <p>Ê¨°„ÅÆÈù¢„ÅØËªä„ÅåÈÄü„Åè„Å™„Çä„Åæ„ÅôÔºÅ</p>
                                )}
                                {ranking.length > 0 ? (
                                    <div>
                                        <p>üèÜ „Éè„Ç§„Çπ„Ç≥„Ç¢„É©„É≥„Ç≠„É≥„Ç∞</p>
                                        {ranking.map((r, i) => (
                                            <p key={`${r.name}-${i}`}>{i + 1}. {r.name} - {r.score}{gameMode === 'pyoko' ? 'm' : ''}</p>
                                        ))}
                                        {topPlayer && <p>„Éà„ÉÉ„Éó„ÅÆ{topPlayer.name}„Åï„Çì„ÄÅÂ§©Êâç„Åô„Åé„Åæ„ÅôÔºÅ</p>}
                                    </div>
                                ) : (
                                    <p>„Åæ„Å†„É©„É≥„Ç≠„É≥„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
                                )}
                                {gameMode === 'pyoko' && (
                                    <button
                                        className="btn"
                                        onTouchEnd={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            handleRetry(e);
                                        }}
                                        onClick={handleRetry}
                                    >
                                        „Åæ„ÅüÈÅä„Å∂
                                    </button>
                                )}
                                {gameMode === 'crossy' && (
                                    <button
                                        className="btn"
                                        onTouchEnd={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            handleNextLevel(e);
                                        }}
                                        onClick={handleNextLevel}
                                    >
                                        Ê¨°„ÅÆÈù¢„Å∏
                                    </button>
                                )}
                                <button
                                    className="btn secondary"
                                    onTouchEnd={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        setGameState('menu');
                                    }}
                                    onClick={() => setGameState('menu')}
                                >
                                    „Ç≤„Éº„É†ÈÅ∏Êäû„Å∏
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Game />);
    </script>
</body>
</html>
